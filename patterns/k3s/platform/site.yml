---
- name: Configure Management Node
  hosts: k3s_management
  become: yes
  roles:
    - role: management
      tags: [management, always]

- name: Configure Common Prerequisites
  hosts: all:!k3s_management
  become: yes
  roles:
    - role: common
      tags: [common, always]

- name: Configure K3s Control Plane
  hosts: k3s_control
  become: yes
  roles:
    - role: control
      tags: [control]
  pre_tasks:
    - name: Check if control plane is already configured
      stat:
        path: /etc/rancher/k3s/k3s.yaml
      register: control_config_check
      tags: [control]
  post_tasks:
    - name: Mark control plane configuration complete
      copy:
        content: "{{ ansible_date_time.iso8601 }}"
        dest: /var/lib/tfgrid-compose/state/control_complete
      delegate_to: "{{ primary_control_node }}"
      tags: [control]

- name: Join K3s Worker Nodes
  hosts: k3s_worker
  become: yes
  roles:
    - role: worker
      tags: [worker]
  pre_tasks:
    - name: Check if worker is already joined
      stat:
        path: /var/lib/rancher/k3s/agent/kubelet.kubeconfig
      register: worker_join_check
      tags: [worker]
  post_tasks:
    - name: Mark worker join complete
      copy:
        content: "{{ ansible_date_time.iso8601 }}"
        dest: /var/lib/tfgrid-compose/state/worker_{{ inventory_hostname }}_complete
      tags: [worker]

- name: Join K3s Ingress Nodes (if configured)
  hosts: k3s_ingress
  become: yes
  roles:
    - role: ingress
      tags: [ingress]
  when: has_ingress_nodes | default(false) | bool

- name: Configure Keepalived for Ingress HA (if configured)
  hosts: k3s_ingress
  become: yes
  roles:
    - role: keepalived
      tags: [keepalived]
  when: has_ingress_nodes | default(false) | bool

- name: Setup local kubeconfig for K3s cluster
  hosts: k3s_management
  become: no
  roles:
    - role: kubeconfig
      tags: [kubeconfig]
  vars:
    primary_control_node: "{{ hostvars['node1']['inventory_hostname'] }}"

- name: Validate cluster readiness before app deployment
  hosts: k3s_management
  become: no
  tasks:
    - name: Wait for all control plane nodes to be ready
      shell: |
        export KUBECONFIG=~/.kube/config
        kubectl wait --for=condition=Ready node --all --timeout=300s
      register: control_nodes_ready
      retries: 3
      delay: 30
      until: control_nodes_ready.rc == 0
      failed_when: control_nodes_ready.rc != 0

    - name: Verify etcd cluster health
      shell: |
        export KUBECONFIG=~/.kube/config
        kubectl get nodes -l node-role.kubernetes.io/control-plane -o name | wc -l
      register: etcd_nodes_count
      failed_when: etcd_nodes_count.stdout | int < 3
      when: "'masters' in groups and groups['masters'] | length >= 3"

    - name: Check CNI pods are running
      shell: |
        export KUBECONFIG=~/.kube/config
        kubectl get pods -n kube-system -l k8s-app=flannel -o jsonpath='{.items[*].status.phase}' | grep -v Running | wc -l
      register: cni_check
      failed_when: cni_check.stdout | int > 0

    - name: Validate MetalLB deployment
      shell: |
        export KUBECONFIG=~/.kube/config
        kubectl get pods -n metallb-system -o jsonpath='{.items[*].status.phase}' | grep -v Running | wc -l
      register: metallb_check
      failed_when: metallb_check.stdout | int > 0

    - name: Check cluster nodes status
      shell: |
        export KUBECONFIG=~/.kube/config
        kubectl get nodes
      register: nodes_status

    - name: Display cluster validation results
      debug:
        msg: |
          ============================================
          CLUSTER VALIDATION SUCCESSFUL
          ============================================
          All control plane nodes are ready.
          CNI (Flannel) is functioning.
          MetalLB is deployed and running.
          Cluster is ready for application deployment.
          ============================================
          {{ nodes_status.stdout_lines | join('\n') }}
          ============================================

- name: Deploy Nginx Ingress to dedicated ingress nodes (if configured)
  hosts: k3s_management
  become: no
  tasks:
    - name: Create Nginx Ingress DaemonSet for ingress nodes
      copy:
        content: |
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: nginx-ingress-controller
            namespace: ingress-nginx
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/component: controller
          spec:
            selector:
              matchLabels:
                app.kubernetes.io/name: ingress-nginx
                app.kubernetes.io/component: controller
            template:
              metadata:
                labels:
                  app.kubernetes.io/name: ingress-nginx
                  app.kubernetes.io/component: controller
              spec:
                nodeSelector:
                  node-role.kubernetes.io/ingress: "true"
                tolerations:
                  - key: "dedicated"
                    operator: "Equal"
                    value: "ingress"
                    effect: "NoSchedule"
                hostNetwork: true
                dnsPolicy: ClusterFirstWithHostNet
                serviceAccountName: ingress-nginx
                containers:
                  - name: controller
                    image: registry.k8s.io/ingress-nginx/controller:v1.8.1
                    args:
                      - /nginx-ingress-controller
                      - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller
                      - --election-id=ingress-controller-leader
                      - --controller-class=k8s.io/ingress-nginx
                      - --ingress-class=nginx
                      - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
                    env:
                      - name: POD_NAME
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.name
                      - name: POD_NAMESPACE
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.namespace
                    ports:
                      - name: http
                        containerPort: 80
                        hostPort: 80
                      - name: https
                        containerPort: 443
                        hostPort: 443
                    livenessProbe:
                      httpGet:
                        path: /healthz
                        port: 10254
                      initialDelaySeconds: 10
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /healthz
                        port: 10254
                      initialDelaySeconds: 10
                      periodSeconds: 10
        dest: /tmp/nginx-ingress-daemonset.yaml
      when: has_ingress_nodes | default(false) | bool

    - name: Apply Nginx Ingress base manifests
      shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml
      when: has_ingress_nodes | default(false) | bool
      ignore_errors: yes

    - name: Wait for ingress-nginx namespace
      shell: kubectl get namespace ingress-nginx
      register: ns_check
      retries: 10
      delay: 5
      until: ns_check.rc == 0
      when: has_ingress_nodes | default(false) | bool
      ignore_errors: yes

    - name: Delete default Nginx Ingress Deployment (we use DaemonSet instead)
      shell: kubectl delete deployment ingress-nginx-controller -n ingress-nginx --ignore-not-found=true
      when: has_ingress_nodes | default(false) | bool
      ignore_errors: yes

    - name: Apply Nginx Ingress DaemonSet for ingress nodes
      shell: kubectl apply -f /tmp/nginx-ingress-daemonset.yaml
      when: has_ingress_nodes | default(false) | bool
      ignore_errors: yes

    - name: Display ingress node public IPs for DNS configuration
      debug:
        msg: |
          ============================================
          INGRESS NODES DEPLOYED SUCCESSFULLY
          ============================================
          Configure your DNS A records to point to these IPs:
          {% for host in groups['k3s_ingress'] %}
          - {{ hostvars[host]['public_ip'] | default('N/A') }}
          {% endfor %}
          ============================================
      when: has_ingress_nodes | default(false) | bool
  tags: [ingress-nginx]
